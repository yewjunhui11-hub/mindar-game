<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
  <title>MindAR 3 Models Spawn</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Arial; }
    canvas, a-scene { touch-action: none; }

    #hint {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      z-index: 10; color: white;
      text-shadow: 0 2px 8px rgba(0,0,0,0.85);
      font-weight: 700; font-size: 14px;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="hint">Scan the target once. Tap a model to remove itâ€”another one will spawn (always 3 total).</div>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    renderer="colorManagement: true; physicallyCorrectLights: true"
  >
    <a-assets>
      <!-- Preload ALL models -->
      <a-asset-item id="c1" src="correct_1.glb"></a-asset-item>
      <a-asset-item id="c2" src="correct_2.glb"></a-asset-item>
      <a-asset-item id="c3" src="correct_3.glb"></a-asset-item>

      <a-asset-item id="w1" src="wrong_1.glb"></a-asset-item>
      <a-asset-item id="w2" src="wrong_2.glb"></a-asset-item>
      <a-asset-item id="w3" src="wrong_3.glb"></a-asset-item>
    </a-assets>

    <a-camera id="cam" position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Anchor on image target -->
    <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
  </a-scene>

  <script>
    // ---------- CONFIG ----------
    const MAX_ON_SCREEN = 3;

    // Spawn area relative to target (tune these)
    const SPAWN_X = 0.65;
    const SPAWN_Y = 0.38;
    const Z = 0.05; // slightly in front of target plane

    // Model scale (you can tweak per model later)
    const MODEL_SCALE = "0.18 0.18 0.18";

    // Which models can spawn
    const MODEL_IDS = ["#c1","#c2","#c3","#w1","#w2","#w3"];

    // ---------- STATE ----------
    const sceneEl = document.querySelector("a-scene");
    const anchorEl = document.getElementById("anchor");

    let started = false; // becomes true after first target detection
    let tapLock = false;

    const raycaster = new THREE.Raycaster();
    const ndc = new THREE.Vector2();

    function rand(min, max) { return Math.random() * (max - min) + min; }

    function lockTapBriefly() {
      tapLock = true;
      setTimeout(() => (tapLock = false), 220);
    }

    function randomModelId() {
      return MODEL_IDS[Math.floor(Math.random() * MODEL_IDS.length)];
    }

    function spawnOne() {
      const ent = document.createElement("a-entity");
      ent.classList.add("spawned"); // marker class

      ent.setAttribute("gltf-model", randomModelId());
      ent.setAttribute("scale", MODEL_SCALE);

      const x = rand(-SPAWN_X, SPAWN_X);
      const y = rand(-SPAWN_Y, SPAWN_Y);
      ent.setAttribute("position", `${x} ${y} ${Z}`);
      ent.setAttribute("rotation", `0 ${rand(0,360)} 0`);

      // Optional: tag if it's correct/wrong (for points later)
      const isWrong = ent.getAttribute("gltf-model").startsWith("#w");
      ent.dataset.type = isWrong ? "wrong" : "correct";

      anchorEl.appendChild(ent);
    }

    function countSpawned() {
      return anchorEl.querySelectorAll(".spawned").length;
    }

    function ensureThree() {
      if (!started) return;
      while (countSpawned() < MAX_ON_SCREEN) spawnOne();
    }

    // ----- (1) Start after first target found -----
    // MindAR emits events on the entity with mindar-image-target
    anchorEl.addEventListener("targetFound", () => {
      if (started) return;
      started = true;
      ensureThree();
    });

    // If tracking lost, we do nothing. When found again, ensureThree() will refill.
    anchorEl.addEventListener("targetLost", () => {
      // optional: keep models as-is; they stay under anchor anyway
      // started remains true
    });

    // ----- (2) Reliable tap detection (manual raycast) -----
    function getAllMeshesUnderAnchor() {
      const meshes = [];
      anchorEl.object3D.traverse(obj => { if (obj.isMesh) meshes.push(obj); });
      return meshes;
    }

    function findSpawnedEntityFromHitObject(obj3d) {
      // Walk up until we find an A-Frame entity (.el)
      let o = obj3d;
      while (o && !o.el) o = o.parent;
      if (!o || !o.el) return null;

      // We want the top-level spawned entity, not an inner mesh
      let el = o.el;
      while (el && el !== anchorEl && !el.classList.contains("spawned")) {
        el = el.parentElement;
      }
      if (el && el.classList && el.classList.contains("spawned")) return el;
      return null;
    }

    function onTap(clientX, clientY) {
      if (!started) return;
      if (tapLock) return;
      lockTapBriefly();

      if (!sceneEl.canvas || !sceneEl.camera) return;

      const rect = sceneEl.canvas.getBoundingClientRect();
      ndc.x = ((clientX - rect.left) / rect.width) * 2 - 1;
      ndc.y = -(((clientY - rect.top) / rect.height) * 2 - 1);

      raycaster.setFromCamera(ndc, sceneEl.camera);

      const meshes = getAllMeshesUnderAnchor();
      const hits = raycaster.intersectObjects(meshes, true);
      if (!hits.length) return;

      const hitEl = findSpawnedEntityFromHitObject(hits[0].object);
      if (!hitEl) return;

      // Remove clicked model
      hitEl.remove();

      // Spawn back to keep 3 total
      ensureThree();
    }

    window.addEventListener("touchstart", (e) => {
      if (!e.touches || !e.touches.length) return;
      const t = e.touches[0];
      onTap(t.clientX, t.clientY);
    }, { passive: true });

    window.addEventListener("mousedown", (e) => {
      onTap(e.clientX, e.clientY);
    });
  </script>
</body>
</html>