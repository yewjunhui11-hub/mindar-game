<script>
  const sceneEl = document.querySelector('a-scene');
  const modelEl = document.getElementById('theModel');

  // spawn area (relative to image target). adjust if needed
  const SPAWN_X = 0.6;
  const SPAWN_Y = 0.35;
  const Z = 0.05; // slightly in front of target so it's easier to tap

  const raycaster = new THREE.Raycaster();
  const ndc = new THREE.Vector2();

  // Prevent double-trigger from a single tap
  let tapLock = false;
  function lockTapBriefly() {
    tapLock = true;
    setTimeout(() => (tapLock = false), 250);
  }

  function rand(min, max) { return Math.random() * (max - min) + min; }

  function respawnModel() {
    // put it somewhere new + show it
    const x = rand(-SPAWN_X, SPAWN_X);
    const y = rand(-SPAWN_Y, SPAWN_Y);
    modelEl.setAttribute('position', `${x} ${y} ${Z}`);
    modelEl.setAttribute('rotation', `0 ${rand(0,360)} 0`);
    modelEl.setAttribute('visible', true);
  }

  function hitTestModel(clientX, clientY) {
    if (!sceneEl.canvas || !sceneEl.camera) return false;

    const rect = sceneEl.canvas.getBoundingClientRect();
    ndc.x = ((clientX - rect.left) / rect.width) * 2 - 1;
    ndc.y = -(((clientY - rect.top) / rect.height) * 2 - 1);

    raycaster.setFromCamera(ndc, sceneEl.camera);

    const meshes = [];
    modelEl.object3D.traverse(obj => { if (obj.isMesh) meshes.push(obj); });

    const hits = raycaster.intersectObjects(meshes, true);
    return hits.length > 0;
  }

  function onTap(clientX, clientY) {
    if (tapLock) return;
    lockTapBriefly();

    // only react if user tapped the model
    if (!hitTestModel(clientX, clientY)) return;

    // hide immediately
    modelEl.setAttribute('visible', false);

    // respawn after a short delay (feels nicer)
    setTimeout(respawnModel, 200);
  }

  // Spawn once at start
  respawnModel();

  // Touch
  window.addEventListener('touchstart', (e) => {
    if (!e.touches || !e.touches.length) return;
    const t = e.touches[0];
    onTap(t.clientX, t.clientY);
  }, { passive: true });

  // Mouse (desktop)
  window.addEventListener('mousedown', (e) => {
    onTap(e.clientX, e.clientY);
  });
</script>